"use strict";(self.webpackChunkrspress_doc_template=self.webpackChunkrspress_doc_template||[]).push([["51050"],{84406:function(n,e,s){s.r(e);var i=s(85893),r=s(50065),l=s(95895);function o(n){let e=Object.assign({h1:"h1",a:"a",p:"p",code:"code",h2:"h2",ul:"ul",li:"li",strong:"strong",pre:"pre",span:"span",div:"div"},(0,r.ah)(),n.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.h1,{id:"calibration",children:[(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#calibration",children:"#"}),"Calibration"]}),"\n",(0,i.jsx)(l.Z,{}),"\n",(0,i.jsxs)(e.p,{children:["In QAT, an important stage is to calculate the quantitative parameter ",(0,i.jsx)(e.code,{children:"scale"}),". A good ",(0,i.jsx)(e.code,{children:"scale"})," can significantly improve the accuracy of the model training results and speed up the convergence of the model. The calibration process is to run a few batch data on floating-point models (only run the forward process, not backward), count the distribution histogram and get ",(0,i.jsx)(e.code,{children:"min_value"})," and ",(0,i.jsx)(e.code,{children:"max_value"}),". Then, use the ",(0,i.jsx)(e.code,{children:"min_value"})," and ",(0,i.jsx)(e.code,{children:"max_value"})," to calculate the scale. When the QAT accuracy is low, calibrating the quantitative parameters like this before QAT can provide better quantitative initilization parameters."]}),"\n",(0,i.jsxs)(e.h2,{id:"how-to-define-calibration-model",children:[(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#how-to-define-calibration-model",children:"#"}),"How to Define Calibration Model"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"No need to change existing models by default"})}),"\n",(0,i.jsxs)(e.p,{children:["Similar to the setting of ",(0,i.jsx)(e.code,{children:"QAT QConfig"})," when defining a quantitative model, it is also necessary to set ",(0,i.jsx)(e.code,{children:"Calibration QConfig"})," when defining a calibration model. However, the latter is simpler as the HAT has already implemented the default settings for ",(0,i.jsx)(e.code,{children:"Calibration QConfig"})," for direct use without any modification to the model."]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Define submodule Calibration QConfig"})}),"\n",(0,i.jsxs)(e.p,{children:["By default, ",(0,i.jsx)(e.code,{children:"Calibration QConfig"})," is set for all modules (inherited from nn.Module) of the model. Therefore, the calibration will count the feature distribution of all modules. If you have special needs, you can customize the implementation of the ",(0,i.jsx)(e.code,{children:"set_calibration_qconfig"})," method in the model:"]}),"\n",(0,i.jsx)(e.pre,{className:"code",children:(0,i.jsx)(e.pre,{className:"shiki css-variables has-line-number",style:{backgroundColor:"var(--shiki-color-background)"},tabIndex:"0",children:(0,i.jsxs)(e.code,{className:"language-python",meta:"",children:[(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Classifier"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"nn"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Module"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"):"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"def"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"__init__"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"self"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"):"})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        ..."})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"  "})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"def"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"forward"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"self"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"x"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"):"})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        ..."})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"      "})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# Customize the module to be calibrated"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"def"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"set_calibration_qconfig"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"self"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ):"})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"      "})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# e.g., you can set the qconfig of loss to None to skip "})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# the calibration on loss."})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# It can relatively reduce unnecessary statistics, reduce "})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# the video memory usage and speed up the calibration."})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" self"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"loss "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"is"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"not"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"None"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            self"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"loss"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"qconfig "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"None"})]}),"\n"]})})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.h2,{id:"run-calibration-on-floating-point-models",children:[(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#run-calibration-on-floating-point-models",children:"#"}),"Run Calibration on Floating-point Models"]}),"\n",(0,i.jsx)(e.p,{children:"HAT comes with built-in calibration functions, whose commands are similar to those in normal training. Simply run the following command:"}),"\n",(0,i.jsx)(e.pre,{className:"code",children:(0,i.jsx)(e.pre,{className:"shiki css-variables has-line-number",style:{backgroundColor:"var(--shiki-color-background)"},tabIndex:"0",children:(0,i.jsxs)(e.code,{className:"language-python",meta:"",children:[(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"python3 tools"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"/"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"train"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"py --stage calibration ..."})]}),"\n"]})})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsxs)(e.strong,{children:["See the ",(0,i.jsx)(e.code,{children:"calibration_trainer"})," settings in the ",(0,i.jsx)(e.code,{children:"config"})," file:"]})}),"\n",(0,i.jsx)(e.pre,{className:"code",children:(0,i.jsx)(e.pre,{className:"shiki css-variables has-line-number",style:{backgroundColor:"var(--shiki-color-background)"},tabIndex:"0",children:(0,i.jsxs)(e.code,{className:"language-python",meta:"",children:[(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# Note: The transforms of the dataset during the calibration can be"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# consistent with that during the training or validation, or customized."})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# By default, `val_batch_processor` is used."})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"calibration_data_loader "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" copy"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deepcopy"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"(data_loader)"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"calibration_data_loader"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"pop"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'sampler'"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:")"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# Calibration do not support DDP or DP"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"calibration_batch_processor "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" copy"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deepcopy"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"(val_batch_processor)"})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number"}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"calibration_trainer "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    type"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Calibrator"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    model"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"model,"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# 1. Set data_loader and batch_processor"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    data_loader"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"calibration_data_loader,"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    batch_processor"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"calibration_batch_processor,"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# 2. Set the number of batches for the calibration to iterate"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    num_stages"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"30"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    ...   "})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:")"})}),"\n"]})})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"1. Setting Dataset:"})}),"\n",(0,i.jsx)(e.p,{children:"The datasets for the calibration cannot be testing datasets (can be training datasets or others). There is no definite conclusions for now about the transforms for data enhancement, you can try either using the transforms consistent with those in normal training or validation, or using the customized transforms."}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"2. Number of images to be iterated in calibration (for reference):"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"classification: 500~1500 images"}),"\n",(0,i.jsx)(e.li,{children:"segmentation && detection: 100~300 images"}),"\n"]}),"\n",(0,i.jsxs)(e.div,{className:"rspress-directive info",children:[(0,i.jsx)(e.div,{className:"rspress-directive-title",children:"Note"}),(0,i.jsx)(e.div,{className:"rspress-directive-content",children:(0,i.jsx)(e.p,{children:"The number of images is not fixed either, the suggestions above are only experiences summarized from existing experiments, which can be adjusted according to the actual situation."})})]}),"\n",(0,i.jsxs)(e.h2,{id:"qat-with-calibration-model",children:[(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#qat-with-calibration-model",children:"#"}),"QAT with Calibration Model"]}),"\n",(0,i.jsx)(e.pre,{className:"code",children:(0,i.jsx)(e.pre,{className:"shiki css-variables has-line-number",style:{backgroundColor:"var(--shiki-color-background)"},tabIndex:"0",children:(0,i.jsxs)(e.code,{className:"language-python",meta:"",children:[(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"qat_trainer "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    type"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"distributed_data_parallel_trainer"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    model"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"model,"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    model_convert_pipeline"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        type"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"ModelConvertPipeline"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        qat_mode"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"fuse_bn"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"# (Optional) Set the scale update factor during QAT training"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        qconfig_params"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            activation_qkwargs"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                averaging_constant"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            ),"})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            weight_qkwargs"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                averaging_constant"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            ),"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        ),"})}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        converters"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"["})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"(type"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Float2QAT"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"),"})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"dict"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                type"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"LoadCheckpoint"'}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                checkpoint_path"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"os.path."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"join"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"("})]}),"\n",(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                    ckpt_dir, "}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"calibration-checkpoint-best.pth.tar"'})]}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"                ),"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"            ),"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"        ],"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"    ),"})}),"\n",(0,i.jsx)(e.span,{className:"line line-number",children:(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:")"})}),"\n"]})})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Setting of averaging_constant:"})}),"\n",(0,i.jsxs)(e.p,{children:["In the QAT, the update rule for the scale parameter is ",(0,i.jsx)(e.code,{children:"scale = (1 - averaging_constant) * scale + averaging_constant * current_scale"})," ."]}),"\n",(0,i.jsxs)(e.p,{children:["It is found in some existing experiments that it may lead to higher accuracy by fixing the scale of the activation after calibration, i.e., by setting ",(0,i.jsx)(e.code,{children:"averaging_constant=0"})," of the activation and ",(0,i.jsx)(e.code,{children:"averaging_constant=1"})," of the weight."]}),"\n",(0,i.jsxs)(e.div,{className:"rspress-directive info",children:[(0,i.jsx)(e.div,{className:"rspress-directive-title",children:"Note"}),(0,i.jsx)(e.div,{className:"rspress-directive-content",children:(0,i.jsx)(e.p,{children:"The setting isn't suitable for all tasks, it can be adjusted according to the actual situation. E.g., Fixing scale in a LiDAR task may result in low accuracy."})})]}),"\n",(0,i.jsx)(e.p,{children:"Next, you only need to start the training by executing the normal QAT command:"}),"\n",(0,i.jsx)(e.pre,{className:"code",children:(0,i.jsx)(e.pre,{className:"shiki css-variables has-line-number",style:{backgroundColor:"var(--shiki-color-background)"},tabIndex:"0",children:(0,i.jsxs)(e.code,{className:"language-python",meta:"",children:[(0,i.jsxs)(e.span,{className:"line line-number",children:[(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"python3 tools"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"/"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"train"}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,i.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"py --stage qat ..."})]}),"\n"]})})})]})}function a(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,r.ah)(),n.components);return e?(0,i.jsx)(e,Object.assign({},n,{children:(0,i.jsx)(o,n)})):o(n)}e.default=a,a.__RSPRESS_PAGE_META={},a.__RSPRESS_PAGE_META["3.0.22%2Fen%2Fguide%2Fadvanced_content%2Fhat%2Ftutorials%2Fcalibration.mdx"]={toc:[{id:"how-to-define-calibration-model",text:"How to Define Calibration Model",depth:2},{id:"run-calibration-on-floating-point-models",text:"Run Calibration on Floating-point Models",depth:2},{id:"qat-with-calibration-model",text:"QAT with Calibration Model",depth:2}],title:"Calibration",frontmatter:{}}},95895:function(n,e,s){s(39710);var i=s(85893),r=s(67294),l=s(45687);s(20388);let o={"zh-CN":n=>`\u{9884}\u{8BA1}\u{9605}\u{8BFB}\u{65F6}\u{95F4}: ${n.minutes>=1?`${Math.ceil(n.minutes)} \u{5206}\u{949F}`:"\u5C0F\u4E8E 1 \u5206\u949F"}`,"en-US":n=>`Estimated reading time: ${n.minutes>=1?`${Math.ceil(n.minutes)} minutes`:"less than 1 minute"}`};function a(n,e,s){let i=Object.keys(o).includes(e)?e:s;return o[i](n)}e.Z=n=>{let{defaultLocale:e="en-US"}=n,s=(0,l.Vi)().page.readingTimeData,o=(0,l.Jr)(),t=(0,l.e7)(),[c,h]=(0,r.useState)(a(s,o,e));return(0,r.useEffect)(()=>{h(a(s,o,e))},[o,s]),(0,i.jsx)("span",{"data-dark":String(t),className:"rp-reading-time",children:c})}}}]);